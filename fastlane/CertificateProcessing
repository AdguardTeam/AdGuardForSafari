# SPDX-FileCopyrightText: AdGuard Software Limited
#
# SPDX-License-Identifier: GPL-3.0-or-later

desc 'Installs or updates certificates and provisioning profiles, which need for build product'
lane :certs do |options|
  is_mas = options[:config] == 'MAS'

  app_id = @build_settings['AG_APP_ID']
  safari_app_ext_id = @build_settings['AG_POPUP_EXTENSION_BUNDLEID']

  infos_for_mas_match = [
    {
      :app_ids => [app_id, safari_app_ext_id],
      :type => 'appstore',
      :other_type => 'mac_installer_distribution',
      :step_name => 'Match certs and provisioning profiles for MAS appstore and mac_installer_distribution'
    }
  ]

  infos_for_standalone_match = [
    {
      :app_ids => [app_id],
      :type => 'developer_id',
      :skip_provisioning_profiles => true,
      :step_name => 'Match certs for Standalone developer_id'
    },
    {
      :app_ids => [app_id],
      :type => 'developer_id_installer',
      :skip_provisioning_profiles => true,
      :step_name => 'Match certs for Standalone developer_id_installer'
    }
  ]

  infos_for_match = is_mas ? infos_for_mas_match : infos_for_standalone_match

  match_certs(infos_for_match: infos_for_match, is_mas: is_mas, is_bamboo: @is_bamboo, options: options)
end

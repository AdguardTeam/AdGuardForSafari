# SPDX-FileCopyrightText: AdGuard Software Limited
#
# SPDX-License-Identifier: GPL-3.0-or-later

import 'Updating/Helpers'
import 'Updating/VersionHelpers'
import 'Updating/NPMUpdater'
import 'Updating/SafariConverterLibUpdater'

desc 'Update third party dependencies

Options:
- packages (optional): Comma-separated list of specific packages to update
- dry_run (optional): Run in dry-run mode to check for updates without applying them

Available packages:
- npm: assistant, safari-extension
- SPM: safariconverterlib

Note: Other SPM packages are updated manually, AdGuard Extra is downloaded during build

Examples:
fastlane update_third_party_deps
fastlane update_third_party_deps packages:assistant
fastlane update_third_party_deps packages:safariconverterlib
fastlane update_third_party_deps dry_run:true'
lane :update_third_party_deps do |options|
  # Validate environment first
  unless validate_environment_variables
    UI.error('Environment validation failed')
    next false
  end

  dry_run = ENV['DRY_RUN'] == 'true' || options[:dry_run]
  target_packages = parse_target_packages(options[:packages])

  # Exit early if package validation failed
  next false if options[:packages] && target_packages.nil?

  UI.header('Updating Third Party Dependencies')

  if target_packages
    UI.message("Target packages: #{target_packages.join(', ')}")
  else
    UI.message('Updating all available dependencies')
  end

  changes_detected = false

  # Update SafariConverterLib if requested
  if should_update_safari_converter_lib?(target_packages)
    UI.header('SafariConverterLib')
    safari_changes = update_safari_converter_lib(dry_run: dry_run)
    changes_detected ||= safari_changes
  end

  # Update npm dependencies
  if should_update_npm_dependencies?(target_packages)
    npm_projects = detect_npm_projects
    if npm_projects.any?
      UI.header('npm Dependencies')
      npm_changes = update_npm_dependencies(npm_projects, target_packages: target_packages)
      changes_detected ||= npm_changes
    else
      UI.important('No npm projects detected - skipping npm updates')
    end
  end

  if changes_detected
    UI.success('Dependencies updated successfully')
    UI.message('Note: ThirdPartyDeps.swift will be regenerated automatically on next build')
  else
    UI.message('No changes detected - all dependencies are up to date')
  end
end

def should_update_safari_converter_lib?(target_packages)
  return true unless target_packages # Update all if no specific packages specified

  target_packages.include?('safariconverterlib')
end

def should_update_npm_dependencies?(target_packages)
  return true unless target_packages # Update all if no specific packages specified

  # Check if any of the specified packages are npm packages
  (target_packages & DefaultUpdateConstants::NPM_PACKAGES).any?
end

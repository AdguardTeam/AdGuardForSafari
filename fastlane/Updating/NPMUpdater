# SPDX-FileCopyrightText: AdGuard Software Limited
#
# SPDX-License-Identifier: GPL-3.0-or-later

# frozen_string_literal: true

# NPM dependency update logic

def detect_npm_projects
  npm_projects = []

  # ContentScript project only
  content_script_path = "#{@root_path}/AdguardMini/PopupExtension/ContentScript"
  content_script_package = "#{content_script_path}/package.json"
  if File.exist?(content_script_package)
    lock_file = detect_npm_lock_file(content_script_path)
    npm_projects << {
      path: content_script_path,
      package_json: content_script_package,
      lock_file: lock_file,
      manager: detect_package_manager(lock_file)
    }
  end

  UI.message("Detected #{npm_projects.count} npm projects")
  npm_projects
end

def detect_npm_lock_file(project_path)
  yarn_lock_path = File.join(project_path, 'yarn.lock')
  return yarn_lock_path if File.exist?(yarn_lock_path)

  nil
end

def detect_package_manager(lock_file)
  return 'yarn' if lock_file && File.basename(lock_file) == 'yarn.lock'

  nil # No supported package manager found
end

def update_npm_dependencies(npm_projects, target_packages: nil)
  overall_changes = false
  project_results = []

  npm_projects.each_with_index do |project, index|
    project_name = File.basename(project[:path])
    UI.message("[#{index + 1}/#{npm_projects.count}] Updating #{project_name}")

    begin
      changes = update_single_npm_project(project, target_packages: target_packages)
      overall_changes ||= changes
      project_results << [project_name, changes ? 'Updated' : 'No changes', project[:manager]]
    rescue StandardError => e
      project_results << [project_name, 'Failed', e.message]
      UI.error("Failed to update #{project_name}: #{e.message}")
    end
  end

  print_table(%w[Project Status Manager], project_results)
  overall_changes
end

def update_single_npm_project(project, target_packages: nil)
  Dir.chdir(project[:path]) do
    # Read current package.json
    package_data = JSON.parse(File.read('package.json'))
    updated_deps = {}

    package_data['dependencies']&.each do |name, version|
      # Filter by target packages if specified
      if target_packages
        package_key = case name
                      when '@adguard/assistant' then 'assistant'
                      when '@adguard/safari-extension' then 'safari-extension'
                      else name
                      end
        next unless target_packages.include?(package_key)
      end

      compatible_version = get_compatible_version(name, version)

      next unless compatible_version && compatible_version != version

      updated_deps[name] = { from: version, to: compatible_version }
      package_data['dependencies'][name] = compatible_version
    end

    changes_detected = updated_deps.any?

    if changes_detected
      # Write updated package.json
      File.write('package.json', "#{JSON.pretty_generate(package_data)}\n")

      # Regenerate yarn.lock
      UI.message('Running yarn install...')
      with_retry(retries: 2) do
        sh('yarn install', log: false)
      end

      update_list = updated_deps.map { |name, versions| "#{name}: #{versions[:from]} → #{versions[:to]}" }
      print_summary("Updated #{updated_deps.count} npm packages", update_list)
    end

    # Always sync Assistant version to ThirdPartyDependencies.plist
    sync_assistant_version_to_plist

    changes_detected
  end
end

def sync_assistant_version_to_plist
  # Always sync Assistant version between resolved lock file and plist
  plist_path = DefaultUpdateConstants.default_meta_plist

  begin
    # Get actual installed version from lock file
    resolved_version = get_resolved_assistant_version
    return unless resolved_version

    # Read and update plist
    plist_data = Plist.parse_xml(plist_path)
    if plist_data && plist_data['assistant']
      plist_version = plist_data['assistant']['Version']

      # Sync only if versions differ
      if resolved_version != plist_version
        plist_data['assistant']['Version'] = resolved_version

        # Write updated plist
        File.write(plist_path, plist_data.to_plist)

        UI.message("Synced Assistant version in ThirdPartyDependencies.plist: #{plist_version} → #{resolved_version}")
      end
    end
  rescue StandardError => e
    UI.error("Failed to sync Assistant version: #{e.message}")
  end
end

def get_resolved_assistant_version
  # Only support yarn.lock
  return parse_yarn_lock_version('@adguard/assistant') if File.exist?('yarn.lock')

  nil
end

def parse_yarn_lock_version(package_name)
  yarn_lock_content = File.read('yarn.lock')

  # Look for the package entry in yarn.lock
  # Format: "@adguard/assistant@^4.3.75":\n  version "4.3.75"
  match = yarn_lock_content.match(/#{Regexp.escape(package_name)}@[^:]+:\s*\n(?:[^\n]*\n)*?\s*version\s+"([^"]+)"/)
  match ? match[1] : nil
rescue StandardError
  nil
end

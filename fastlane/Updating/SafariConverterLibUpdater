# SPDX-FileCopyrightText: AdGuard Software Limited
#
# SPDX-License-Identifier: GPL-3.0-or-later

# frozen_string_literal: true

# SafariConverterLib update logic

def update_safari_converter_lib(dry_run: false)
  project_pbxproj_path = "#{@project_file}/project.pbxproj"
  
  unless File.exist?(project_pbxproj_path)
    UI.error("project.pbxproj not found at: #{project_pbxproj_path}")
    return false
  end

  # Get current version from project.pbxproj
  current_version = get_safari_converter_lib_version(project_pbxproj_path)
  unless current_version
    UI.error("Could not determine current SafariConverterLib version")
    return false
  end

  # Get latest version from GitHub
  latest_version = get_latest_safari_converter_lib_version
  unless latest_version
    UI.error("Could not fetch latest SafariConverterLib version")
    return false
  end

  UI.message("SafariConverterLib: #{current_version} → #{latest_version}")
  
  if current_version == latest_version
    UI.message("SafariConverterLib is up to date")
    return false
  end

  if dry_run
    UI.important("DRY RUN: Would update SafariConverterLib from #{current_version} to #{latest_version}")
    return true
  end

  # Update project.pbxproj
  update_safari_converter_lib_in_project(project_pbxproj_path, latest_version)
  
  # Run xcodebuild to resolve packages
  UI.message("Resolving Swift packages...")
  sh("xcodebuild -resolvePackageDependencies -project #{@project_file}")
  
  UI.success("Updated SafariConverterLib: #{current_version} → #{latest_version}")
  true
rescue StandardError => e
  UI.error("Failed to update SafariConverterLib: #{e.message}")
  false
end

def get_safari_converter_lib_version(project_path)
  content = File.read(project_path)

  # Look for SafariConverterLib branch specification
  match = content.match(/repositoryURL = "https:\/\/github\.com\/AdguardTeam\/SafariConverterLib";\s*requirement = \{\s*branch = ([^;]+);/)
  return match[1].strip if match

  nil
rescue StandardError => e
  UI.error("Failed to read SafariConverterLib version: #{e.message}")
  nil
end

def get_latest_safari_converter_lib_version
  # Get latest tag from SafariConverterLib repository
  result = sh("git ls-remote --tags https://github.com/AdguardTeam/SafariConverterLib.git", log: false)
  
  tags = result.split("\n")
                .map { |line| line.split("\t").last }
                .select { |ref| ref.start_with?('refs/tags/') }
                .map { |ref| ref.gsub('refs/tags/', '') }
                .reject { |tag| tag.include?('^{}') }
                .select { |tag| tag.match?(/^v?\d+\.\d+\.\d+/) }

  # Sort by version and get the latest
  latest_tag = tags.sort_by { |tag| Gem::Version.new(tag.gsub(/^v/, '')) }.last
  
  UI.message("Latest SafariConverterLib version: #{latest_tag}")
  latest_tag
rescue StandardError => e
  UI.error("Failed to fetch SafariConverterLib versions: #{e.message}")
  nil
end

def update_safari_converter_lib_in_project(project_path, new_version)
  content = File.read(project_path)

  # Update branch specification
  updated_content = content.gsub(
    /(repositoryURL = "https:\/\/github\.com\/AdguardTeam\/SafariConverterLib";\s*requirement = \{\s*branch = )[^;]+(;)/,
    "\\1#{new_version}\\2"
  )

  File.write(project_path, updated_content)
  UI.message("Updated SafariConverterLib version in project.pbxproj")
rescue StandardError => e
  UI.error("Failed to update project.pbxproj: #{e.message}")
  raise
end

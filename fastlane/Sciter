# SPDX-FileCopyrightText: AdGuard Software Limited
#
# SPDX-License-Identifier: GPL-3.0-or-later

# frozen_string_literal: true

desc 'Create sciter resources and UI'
desc 'Options:'
desc '  - config: STRING If config is set to Debug, sciter resources will be built in `dev` configuration, otherwise `prod`. The default value is empty.'
lane :build_sciter_ui do |options|
  # Need for building Sciter UI
  ENV['APP_VERSION'] = @build_settings['AG_FULL_VERSION'] if ENV['APP_VERSION'].nil?
  is_dev_build = options[:config] == 'Debug'

  build_type = 'prod'
  build_type = 'dev' if is_dev_build

  Dir.chdir('..') do
    sh(
      'yarn',
      error_callback: lambda { |error_output|
        UI.user_error!("Failed run yarn: #{error_output}")
      }
    )
    sh(
      'yarn',
      "build:#{build_type}",
      error_callback: lambda { |error_output|
        UI.user_error!("Failed build Sciter resources: #{error_output}")
      }
    )
    sh(
      'AdguardMini/Scripts/generateUI.sh',
      error_callback: lambda { |error_output|
        UI.user_error!("Failed generate UI: #{error_output}")
      }
    )
  end
end

desc 'Update proto schema'
lane :update_proto_schema do |_options|
  tools_dir = File.expand_path('../build/protoc-tools', __dir__)
  protoc_path = File.join(tools_dir, 'bin', 'protoc')
  protoc_gen_swift_path = File.join(tools_dir, 'bin', 'protoc-gen-swift')

  # Check if tools are installed
  unless File.executable?(protoc_path) && File.executable?(protoc_gen_swift_path)
    UI.user_error!(
      "protoc tools not found!\n" \
      'Please run: ./configure.sh dev'
    )
  end

  # Extract and verify versions
  protoc_version = sh("'#{protoc_path}' --version", log: false).strip.match(/libprotoc (\d+\.\d+(?:\.\d+)?)/)[1]
  gen_swift_version = sh("'#{protoc_gen_swift_path}' --version", log: false).strip.match(/(\d+\.\d+\.\d+)/)[1]

  UI.success('Version check passed:')
  UI.message("  protoc:            #{protoc_version}")
  UI.message("  protoc-gen-swift:  #{gen_swift_version}")

  # Configure PATH to use local binaries
  tools_bin = File.join(tools_dir, 'bin')
  original_path = ENV['PATH']

  begin
    ENV['PATH'] = "#{tools_bin}:#{original_path}"
    Dir.chdir('..') do
      sh('AdguardMini/Scripts/updateProtoSchema.sh')
    end
  rescue => e
    UI.user_error!("Failed generate proto schema: #{e.message}")
  ensure
    ENV['PATH'] = original_path
  end
end

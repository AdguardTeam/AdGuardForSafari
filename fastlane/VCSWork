# SPDX-FileCopyrightText: AdGuard Software Limited
#
# SPDX-License-Identifier: GPL-3.0-or-later

desc "Inrement some version"
desc "Required option:"
desc "  - type: STRING Part of the version that will be increased. Available: 'major', 'minor', 'patch', 'build'"
desc "Increasing the senior version leads to zeroing out the junior versions, except for the build number."
lane :increment_version do |options|
  type = options[:type]
  Actions.execute_action("Inrement #{type} version") do
    available_options = ["major", "minor", "patch", "build"]
    UI.user_error!("Missing argument: 'type:<WHAT_INCREMENT>'") if type.nil?

    case type
    when "major"
      increment_major_version
    when "minor"
      increment_minor_version
    when "patch"
      increment_patch_version
    when "build"
      increment_build_number
    else
      UI.user_error!("Argument 'type' can be only #{available_options}") if !available_options.include?(options[:type])
    end
    UI.success "#{type.capitalize} version updated."
  end
end

def increment_major_version
  increment(ConfigConstant::MAJOR_VERSION)
  increment(ConfigConstant::MINOR_VERSION, 0)
  increment(ConfigConstant::PACTH_VERSION, 0)
  increment_build_number
end

def increment_minor_version
  increment(ConfigConstant::MINOR_VERSION)
  increment(ConfigConstant::PACTH_VERSION, 0)
  increment_build_number
end

def increment_patch_version
  increment(ConfigConstant::PACTH_VERSION)
  increment_build_number
end

def increment_build_number
  increment(ConfigConstant::BUILD_VERSION)
end

def increment(config_constant, custom_number = nil)
  Dir.chdir("..") do
    FastlaneCore::CommandExecutor.execute(
      command: "Support/Scripts/increment-some-number.sh '#{config_constant}' #{custom_number}",
      print_all: true,
      error: proc do |error_output|
        UI.user_error!("Failed run increment-build-number: #{error_output}")
      end
    )
  end
end

module ConfigConstant
  MAJOR_VERSION = "AG_MAJOR_VERSION"
  MINOR_VERSION = "AG_MINOR_VERSION"
  PACTH_VERSION = "AG_PATCH_VERSION"
  BUILD_VERSION = "AG_BUILD"
end
